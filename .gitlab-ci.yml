cache:
  paths:
    - _pacman_cache

.build:
  stage: build
  image: archlinux/base:latest
  variables:
    PACMAN_CACHE: $CI_PROJECT_DIR/_pacman_cache
  artifacts:
    when: always
    paths:
      - _build/meson-logs
  before_script:
    - pacman -Syu --noconfirm --needed --cachedir $PACMAN_CACHE
        base-devel
        git
        gobject-introspection
        meson
        vala
        ${EXTRA_PKGS}
  script:
    - meson _build
        -D enable-f16c=true
        -D enable-mmx=true
        -D enable-sse=true
        -D enable-sse2=true
        -D enable-sse3=true
        -D enable-sse4_1=true
        -D with-docs=true
        ${EXTRA_OPTIONS}
    - ninja -C _build
    - ninja -C _build test
  after_script:
    # Remove all cached packages but the latest version
    - pacman -S --noconfirm --cachedir $PACMAN_CACHE pacman-contrib
    - paccache -r -k1 --cachedir $PACMAN_CACHE

latest-lcms:
  extends: .build
  variables:
    EXTRA_OPTIONS : "-Dwith-lcms=true"
    EXTRA_PKGS: "lcms2"

latest-nolcms:
  extends: .build
  variables:
    EXTRA_OPTIONS : "-Dwith-lcms=false"
    EXTRA_PKGS: ""

win64:
  image: debian:testing
  stage: build
  artifacts:
    when: always
    paths:
      - _build/meson-logs
  variables:
    XDG_CACHE_HOME: "$CI_PROJECT_DIR/.cache/"
    XDG_DATA_HOME:  "$CI_PROJECT_DIR/.local/share/"
  cache:
    paths:
    - .cache/crossroad/
  before_script:
    - apt-get update
    - apt-get install -y --no-install-recommends
        apt-utils
    - apt-get install -y --no-install-recommends
        build-essential
        cpio
        gcc-mingw-w64-x86-64
        g++-mingw-w64-x86-64
        git
        meson
        pkg-config
        python3-distutils
        python3-docutils
        python3-pip
        rpm
    - apt-get install -y --reinstall ca-certificates
    - git clone --depth=1 git://git.tuxfamily.org/gitroot/crossroad/crossroad.git
    - cd crossroad && ./setup.py install --prefix=`pwd`/../.local && cd ..
    - pip3 install zstandard
  script:
    - export PATH="`pwd`/.local/bin:$PATH"
    - mkdir _build && cd _build
    - echo 'crossroad source msys2 && crossroad install lcms2' | crossroad w64 gimp --run="-"
    - echo 'crossroad meson .. -Denable-gir=false && ninja' | crossroad w64 gimp --run="-"

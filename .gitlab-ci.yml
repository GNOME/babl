cache:
  paths:
    - _pacman_cache

.build:
  stage: build
  image: archlinux/base:latest
  before_script:
    - pacman -Syu --noconfirm --needed --cachedir `pwd`/_pacman_cache
        base-devel
        git
        ${EXTRA_PKGS}

.meson-build:
  extends: .build
  artifacts:
    when: always
    paths:
      - _build/meson-logs
  script:
    - meson _build
        -D enable-f16c=true
        -D enable-mmx=true
        -D enable-sse=true
        -D enable-sse2=true
        -D enable-sse3=true
        -D enable-sse4_1=true
        -D with-docs=true
        ${LCMS_OPTION}
    - ninja -C _build
    - ninja -C _build test

.autotools-build:
  extends: .build
  artifacts:
    when: always
    paths:
      - _build/*.log
      - _build/*/*.log
      - _build/*/*/*.log
  script:
    - mkdir _build
    - cd _build
    - ../autogen.sh
        --enable-docs
        --enable-f16c
        --enable-mmx
        --enable-sse
        --enable-sse2
        --enable-sse3
        --enable-sse4_1
        ${LCMS_OPTION}
    - make
    - make check

latest-meson-lcms:
  extends: .meson-build
  variables:
    LCMS_OPTION : "-Dwith-lcms=true"
    EXTRA_PKGS: "lcms2 meson"

latest-meson-nolcms:
  extends: .meson-build
  variables:
    LCMS_OPTION : "-Dwith-lcms=false"
    EXTRA_PKGS: "meson"

latest-autotools-lcms:
  extends: .autotools-build
  variables:
    LCMS_OPTION : "--with-lcms"
    EXTRA_PKGS: "lcms2"

latest-autotools-nolcms:
  extends: .autotools-build
  variables:
    LCMS_OPTION : "--without-lcms"
